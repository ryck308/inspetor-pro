<!doctype html>
<html>
<head>
  <meta charset="utf-8"/><title>InspetorPro — Painel TV</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    html,body{height:100%;margin:0;background:#000;color:#fff;font-family:Arial}
    .wrap{display:flex;align-items:center;justify-content:center;height:100%}
    .imgbox{position:relative;width:100%;height:100%;overflow:hidden}
    img{width:100%;height:100%;object-fit:cover}
    .badge{position:absolute; right:24px; top:24px; background:#D32F2F; color:#fff; padding:12px 18px; font-weight:700; font-size:32px; border-radius:6px; display:none}
    .overlayText{position:absolute; left:24px; bottom:24px; font-size:28px; background:rgba(0,0,0,0.4); padding:10px 14px; border-radius:6px; display:none}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="imgbox">
      <img id="mainImg" src="/assets/chamar_default.png" alt="Painel"/>
      <div id="badge" class="badge">PRIORIDADE</div>
      <div id="txt" class="overlayText"></div>
    </div>
  </div>

<script type="module">
  import { supabase } from '/supabase.js';

  const panelChannel = supabase.channel('public:panel_state');
  let cycleTimer = null;
  let showingCall = false;

  function showImage(url, prioridade, nome, servico){
    const img = document.getElementById('mainImg');
    const badge = document.getElementById('badge');
    const txt = document.getElementById('txt');
    if(url) img.src = url;
    if(prioridade) badge.style.display='block'; else badge.style.display='none';
    if(nome){ txt.style.display='block'; txt.innerText = `${nome} — ${servico}`; } else txt.style.display='none';
  }

  async function getConfigMap(){
    const { data } = await supabase.from('config').select('*');
    const map = {};
    (data||[]).forEach(r=> map[r.key]=r.value);
    return map;
  }

  async function startCycle(){
    let step = 0;
    const cfg = await getConfigMap();
    async function next(){
      const { data: state } = await supabase.from('panel_state').select('*').eq('id',1).single();
      if(state && state.reiniciar_ciclo) return;
      if(step === 0){
        const url = cfg['ultimas_chamadas_asset_url'] || '/assets/ultimas.png';
        showImage(url,false,'','');
      } else {
        const url = cfg['proximas_chamadas_asset_url'] || '/assets/proximas.png';
        showImage(url,false,'','');
      }
      step = (step+1)%2;
      cycleTimer = setTimeout(next, 60000);
    }
    next();
  }

  // subscribe to panel_state changes
  supabase
    .channel('public:panel_state')
    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'panel_state', filter: 'id=eq.1' }, async payload => {
      const s = payload.new;
      if(s.reiniciar_ciclo){
        showingCall = true;
        if(cycleTimer){ clearTimeout(cycleTimer); cycleTimer=null; }
        let imgUrl = s.image_asset || '';
        if(!imgUrl){
          const cfg = await getConfigMap();
          imgUrl = s.prioridade ? (cfg['painel_csv_asset_url'] || '/assets/csv.png') : (cfg['chamar_veiculo_asset_default'] || '/assets/chamar_default.png');
        }
        showImage(imgUrl, !!s.prioridade, s.nome_condutor || '', s.servico || '');
        if(s.mensagem_voz){
          playMessageRepeated(s.mensagem_voz);
        }
        const dur = (s.duracao_segundos || 50) * 1000;
        setTimeout(async ()=>{
          showingCall = false;
          await supabase.from('panel_state').update({ reiniciar_ciclo:false }).eq('id',1);
          startCycle();
        }, dur);
      }
    })
    .subscribe();

  (async ()=>{
    const { data: state } = await supabase.from('panel_state').select('*').eq('id',1).single();
    if(state && state.reiniciar_ciclo){
      // handled by subscription
    } else {
      startCycle();
    }
  })();

  // TTS helper (browser)
  function playMessageRepeated(text){
    if(!('speechSynthesis' in window)) return;
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = 'pt-BR';
    utter.rate = 0.95;
    let played = 0;
    function speakOnce(){
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(utter);
      played++;
      if(played < 3){
        setTimeout(()=> speakOnce(), 8000 + (utter.text.length * 60));
      }
    }
    speakOnce();
  }
</script>
</body>
</html>
